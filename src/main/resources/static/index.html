<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking App</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ccc; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .hidden { display: none; }
        input, button { margin: 5px 0; padding: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Banking App</h1>

    <div id="auth-section" class="container">
        <h2>Login / Register</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <br>
        <button onclick="login()">Login</button>
        <button onclick="register()">Register</button>
    </div>

    <div id="dashboard-section" class="container hidden">
        <h2>Welcome, <span id="user-email"></span></h2>
        <h3>Balance: $<span id="user-balance"></span></h3>
        <button onclick="logout()">Logout</button>

        <div class="container">
            <h3>Transfer Money</h3>
            <input type="email" id="receiver-email" placeholder="Receiver Email">
            <input type="number" id="amount" placeholder="Amount">
            <button onclick="transfer()">Transfer</button>
        </div>

        <div class="container">
            <h3>Transaction History</h3>
            <button onclick="loadHistory()">Refresh History</button>
            <table id="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Sender</th>
                        <th>Receiver</th>
                        <th>Amount</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentUser = null;

        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (response.ok) {
                    alert('Registration successful! Please login.');
                } else {
                    alert('Registration failed');
                }
            } catch (e) { console.error(e); }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (response.ok) {
                    currentUser = await response.json();
                    showDashboard();
                } else {
                    alert('Login failed');
                }
            } catch (e) { console.error(e); }
        }

        function showDashboard() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('user-email').innerText = currentUser.email;
            updateBalance();
            loadHistory();
        }

        function logout() {
            currentUser = null;
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        async function updateBalance() {
            const response = await fetch(`/api/account/${currentUser.id}`);
            if (response.ok) {
                currentUser = await response.json();
                document.getElementById('user-balance').innerText = currentUser.balance;
            }
        }

        async function transfer() {
            const receiverEmail = document.getElementById('receiver-email').value;
            const amount = document.getElementById('amount').value;
            try {
                const response = await fetch('/api/transfer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        senderId: currentUser.id,
                        receiverEmail: receiverEmail,
                        amount: amount
                    })
                });
                if (response.ok) {
                    alert('Transfer successful');
                    updateBalance();
                    loadHistory();
                } else {
                    alert('Transfer failed: ' + (await response.text())); // Simple error handling
                }
            } catch (e) { console.error(e); }
        }

        async function loadHistory() {
            const response = await fetch(`/api/history/${currentUser.id}`);
            if (response.ok) {
                const transactions = await response.json();
                const tbody = document.querySelector('#history-table tbody');
                tbody.innerHTML = '';
                transactions.forEach(t => {
                    const row = `<tr>
                        <td>${t.id}</td>
                        <td>${t.sender ? t.sender.email : 'System'}</td>
                        <td>${t.receiver ? t.receiver.email : 'System'}</td>
                        <td>${t.amount}</td>
                        <td>${new Date(t.timestamp).toLocaleString()}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
        }
    </script>
</body>
</html>
